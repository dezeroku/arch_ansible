---
- name: Install pacoloco and reflector
  become: true
  become_user: root
  community.general.pacman:
    name:
      - pacoloco
      - reflector
  when: pacoloco_setup_server

- name: Copy pacoloco config file
  become: true
  become_user: root
  ansible.builtin.copy:
    src: pacoloco.yaml
    dest: /etc/pacoloco.yaml
    mode: 0644
  when: pacoloco_setup_server
  register: pacoloco_config_copy

- name: Check if mirrorlist exists
  become: true
  become_user: root
  ansible.builtin.stat:
    path: /etc/pacoloco_mirrorlist
  register: mirrorlist_file
  when: pacoloco_setup_server

- name: Find fast mirrors with reflector
  become: true
  become_user: root
  ansible.builtin.command:
    cmd: reflector --latest 100 --sort rate --score 10 --save /etc/pacoloco_mirrorlist
  when: pacoloco_setup_server and ((not mirrorlist_file.stat.exists) or ((mirrorlist_file.stat.exists and mirrorlist_file.stat.isreg) and (not (lookup('ansible.builtin.file', '/etc/pacoloco_mirrorlist') | regex_search("Arch Linux mirrorlist generated by Reflector")))))
  changed_when: true

- name: Start and enable pacoloco
  become: true
  become_user: root
  ansible.builtin.systemd:
    name: pacoloco
    enabled: true
    state: "{{ (pacoloco_config_copy.changed) | ternary('restarted', 'started') }}"
  when: pacoloco_setup_server

- name: Set the pacoloco on top of pacman mirrorlist
  become: true
  become_user: root
  ansible.builtin.lineinfile:
    dest: /etc/pacman.d/mirrorlist
    state: "present"
    line: "Server = {{ pacoloco_server_url }}/repo/{{ pacoloco_repo }}/$repo/os/$arch"
    insertbefore: BOF
  when: pacoloco_setup_client
